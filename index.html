<!DOCTYPE html>
<html>
<head>
  <title>Карта объектов из CSV</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    #map { width: 100%; height: 600px; margin: 20px auto; border: 1px solid #ccc; }
    h2 { text-align: center; font-family: Arial, sans-serif; }
    .info { padding: 6px 8px; background: white; background: rgba(255,255,255,0.8); }
    .custom-icon {
      background-color: #ff0000;
      border-radius: 50%;
      border: 2px solid white;
    }
  </style>
</head>
<body>
  <h2>Объекты захламления на карте Sentinel-2 (SWIR)</h2>
  <div id="map"></div>

  <script>
    // Инициализация карты
    const map = L.map('map').setView([60.5, 72.2], 6);
    
    // Добавление слоя Sentinel-2 (SWIR)
    const sentinelLayer = L.tileLayer(
      'https://services.sentinel-hub.com/ogc/wms/10084d2d-cc90-4fd3-8c37-8c6f72f892b9?' +
      'SERVICE=WMS&REQUEST=GetMap&LAYERS=SWIR&' +
      'BBOX=60,65,75,55&WIDTH=1200&HEIGHT=800&' +
      'TIME=2024-01-01/2024-05-31&FORMAT=image/jpeg&SHOWLOGO=false',
      {
        attribution: 'Sentinel-2 © ESA/Sentinel Hub',
        maxZoom: 18
      }
    ).addTo(map);

    // Создаем кастомную иконку для маркеров
    const customIcon = L.divIcon({
      className: 'custom-icon',
      iconSize: [15, 15],
      html: ''
    });

    // Создаем слой для маркеров
    const markersLayer = L.layerGroup().addTo(map);

    // Функция для загрузки и обработки CSV
    function loadCSV() {
      Papa.parse('МестаНРО_для ГИС Хакатона.csv', {
        download: true,
        header: true,
        skipEmptyLines: true,
        encoding: 'UTF-8',
        complete: function(results) {
          console.log('Загружено записей:', results.data.length);
          
          results.data.forEach(row => {
            try {
              // Преобразуем координаты, заменяя запятые на точки
              const latStr = (row.Широта || '').toString().replace(',', '.').trim();
              const lngStr = (row.Долгота || '').toString().replace(',', '.').trim();
              
              const lat = parseFloat(latStr);
              const lng = parseFloat(lngStr);
              
              if (!isNaN(lat) && !isNaN(lng) {
                // Создаем маркер с кастомной иконкой
                const marker = L.marker([lat, lng], {icon: customIcon}).addTo(markersLayer);
                
                // Формируем popup-контент
                let popupContent = `<b>${row.Наименование || 'Объект'}</b><hr>`;
                popupContent += `<b>ID:</b> ${row['ID карточки'] || 'нет данных'}<br>`;
                popupContent += `<b>Местоположение:</b> ${row.Местоположение || 'нет данных'}<br>`;
                popupContent += `<b>Дата обнаружения:</b> ${row['Дата обнаружения'] || 'нет данных'}<br>`;
                popupContent += `<b>Тип отходов:</b> ${row['Тип отходов'] || 'нет данных'}<br>`;
                popupContent += `<b>Площадь:</b> ${row['Площадь, га'] || 'нет данных'} га<br>`;
                popupContent += `<b>Объем:</b> ${row['Объем, м3'] || 'нет данных'} м³`;
                
                marker.bindPopup(popupContent);
              } else {
                console.warn('Некорректные координаты:', row);
              }
            } catch (e) {
              console.error('Ошибка обработки строки:', row, e);
            }
          });
          
          // Автоматически подгоняем карту под все маркеры
          if (markersLayer.getLayers().length > 0) {
            map.fitBounds(markersLayer.getBounds());
            console.log('Маркеров добавлено:', markersLayer.getLayers().length);
          } else {
            console.warn('Не удалось добавить ни одного маркера');
          }
        },
        error: function(error) {
          console.error('Ошибка загрузки CSV:', error);
          alert('Ошибка загрузки файла данных. Проверьте консоль для подробностей.');
        }
      });
    }

    // Загружаем данные при открытии страницы
    loadCSV();
  </script>
</body>
</html>
