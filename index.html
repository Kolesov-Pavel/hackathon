<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Карта объектов из JSON</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <style>
    /* Ваши стили остаются без изменений */
  </style>
</head>
<body>
  <!-- HTML-структура остается без изменений -->

  <script>
    // ... предыдущий код инициализации карты ...

    // Функция для загрузки JSON
    function loadJSON() {
      const loadingElement = document.getElementById('loading');
      const errorElement = document.getElementById('error');
      
      loadingElement.textContent = 'Загрузка данных...';
      errorElement.style.display = 'none';
      
      fetch('hm.json')
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          // Обрабатываем разные форматы данных:
          let features = [];
          
          // 1. Если это FeatureCollection GeoJSON
          if (data.type === "FeatureCollection") {
            features = data.features;
          } 
          // 2. Если это массив объектов
          else if (Array.isArray(data)) {
            features = data.map(item => ({
              type: "Feature",
              geometry: {
                type: "Point",
                coordinates: [item.Долгота, item.Широта]
              },
              properties: item
            }));
          }
          // 3. Если это отдельный объект
          else if (typeof data === "object" && data.Долгота && data.Широта) {
            features = [{
              type: "Feature",
              geometry: {
                type: "Point",
                coordinates: [data.Долгота, data.Широта]
              },
              properties: data
            }];
          } else {
            throw new Error("Неизвестный формат данных");
          }

          // Проверяем координаты
          features.forEach(feature => {
            const coords = feature.geometry.coordinates;
            if (isNaN(coords[0]) || isNaN(coords[1])) {
              throw new Error(`Неверные координаты: ${coords}`);
            }
          });

          // Создаем GeoJSON слой
          const geoJsonLayer = L.geoJSON({
            type: "FeatureCollection",
            features: features
          }, {
            pointToLayer: function(feature, latlng) {
              return L.circleMarker(latlng, markerStyle);
            },
            onEachFeature: function(feature, layer) {
              const props = feature.properties;
              let popupContent = `<div style="max-width: ${isMobile ? '250px' : '350px'}">`;
              popupContent += `<b>${props.Наименование || 'Объект'}</b><hr style="margin:5px 0">`;
              popupContent += `<small>`;
              // Добавляем все свойства
              for (const key in props) {
                if (props.hasOwnProperty(key) && props[key]) {
                  popupContent += `<b>${key}:</b> ${props[key]}<br>`;
                }
              }
              popupContent += `</small></div>`;
              
              layer.bindPopup(popupContent, {
                maxWidth: isMobile ? 300 : 400
              });
            }
          }).addTo(map);
          
          // Центрируем карту на объектах
          if (features.length > 0) {
            map.fitBounds(geoJsonLayer.getBounds(), {
              padding: [50, 50]
            });
          }
          
          loadingElement.style.display = 'none';
        })
        .catch(error => {
          console.error('Ошибка загрузки:', error);
          loadingElement.style.display = 'none';
          errorElement.innerHTML = `
            <strong>Ошибка загрузки данных:</strong> ${error.message}<br><br>
            Проверьте, что файл hm.json содержит данные в одном из форматов:<br><br>
            1. Отдельный объект: {"Долгота": 72.21, "Широта": 60.49, ...}<br>
            2. Массив объектов: [{"Долгота": 72.21, "Широта": 60.49, ...}, ...]<br>
            3. GeoJSON FeatureCollection<br><br>
            <small>Подробности в консоли (F12)</small>
          `;
          errorElement.style.display = 'block';
        });
    }

    // ... остальной код ...
  </script>
</body>
</html>
