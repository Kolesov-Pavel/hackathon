<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Å—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ—Ç—Ö–æ–¥–æ–≤</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      touch-action: manipulation;
      overscroll-behavior-y: none;
    }
    #map-container {
      position: fixed;
      width: 100%;
      height: 100vh;
      top: 0;
      left: 0;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    h2 {
      text-align: center;
      padding: 10px;
      margin: 0;
      background-color: #f8f9fa;
      font-size: 1rem;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.95);
      padding: 20px;
      border-radius: 5px;
      z-index: 2000;
      text-align: center;
      max-width: 90%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .error {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,0,0,0.9);
      color: white;
      padding: 20px;
      border-radius: 5px;
      z-index: 2000;
      text-align: center;
      max-width: 90%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .map-controls {
      position: fixed;
      top: 60px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    .control-btn {
      width: 44px;
      height: 44px;
      background: white;
      border-radius: 50%;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      user-select: none;
      touch-action: manipulation;
    }
    .control-btn.active {
      background: #4CAF50;
      color: white;
      border-color: #388E3C;
    }
    .mobile-controls {
      position: fixed;
      bottom: 20px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 100%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    .preview-image {
      max-width: 100%;
      max-height: 150px;
      margin-top: 10px;
      border-radius: 5px;
    }
    #search-container {
      position: fixed;
      top: 60px;
      left: 10px;
      right: 60px;
      z-index: 1000;
      background: white;
      padding: 5px;
      border-radius: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #search-input {
      width: 100%;
      padding: 8px 15px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
    }
    #search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border-radius: 0 0 10px 10px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      display: none;
      -webkit-overflow-scrolling: touch;
    }
    .search-result-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .search-result-item:hover {
      background-color: #f5f5f5;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
    }
    button[type="button"] {
      background: #f44336;
    }
    .leaflet-popup-content {
      max-height: 60vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .leaflet-popup-content img {
      max-width: 100%;
      height: auto;
    }
    
    /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    @media (max-width: 360px) {
      h2 {
        font-size: 0.9rem;
        padding: 8px;
      }
      .control-btn {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      .map-controls {
        top: 50px;
      }
      #search-container {
        top: 50px;
      }
    }
  </style>
</head>
<body>
  <div id="map-container">
    <h2>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Å—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ—Ç—Ö–æ–¥–æ–≤</h2>
    <div id="map"></div>
    <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    <div class="error" id="error"></div>
    
    <div class="map-controls" id="mapControls">
      <div class="control-btn active" id="satelliteBtn" title="–°–ø—É—Ç–Ω–∏–∫">üõ∞</div>
      <div class="control-btn" id="urbanBtn" title="–ì–æ—Ä–æ–¥">üèô</div>
      <div class="control-btn" id="terrainBtn" title="–ú–µ—Å—Ç–Ω–æ—Å—Ç—å">‚õ∞</div>
      <div class="control-btn" id="addBtn" title="–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç"><i class="fas fa-plus"></i></div>
    </div>
    
    <div class="mobile-controls" id="mobileControls">
      <div class="control-btn" id="zoomIn">+</div>
      <div class="control-btn" id="zoomOut">-</div>
      <div class="control-btn" id="locate">‚åñ</div>
    </div>
    
    <div id="search-container">
      <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤...">
      <div id="search-results"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ -->
  <div class="modal" id="addModal">
    <div class="modal-content">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç</h3>
      <form id="addForm">
        <div class="form-group">
          <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</label>
          <input type="text" name="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" required>
        </div>
        <div class="form-group">
          <label>–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤:</label>
          <input type="text" name="–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤" required>
        </div>
        <div class="form-group">
          <label>–û–±—ä–µ–º (–º¬≥):</label>
          <input type="number" name="–û–±—ä–µ–º, –º3" step="0.1" required>
        </div>
        <div class="form-group">
          <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è:</label>
          <input type="file" id="photoUpload" accept="image/*" capture="environment">
          <img id="photoPreview" class="preview-image" style="display: none;">
        </div>
        <div class="form-group">
          <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button type="button" id="cancelAdd">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ -->
  <div class="modal" id="photoModal">
    <div class="modal-content">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</h3>
      <form id="photoForm">
        <div class="form-group">
          <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ:</label>
          <input type="file" id="objectPhoto" accept="image/*" capture="environment" required>
          <img id="objectPhotoPreview" class="preview-image" style="display: none;">
        </div>
        <div class="form-group">
          <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <button type="button" id="cancelPhoto">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentData = [];
    let selectedMarker = null;
    const API_ENDPOINT = 'api.php';
    let markersLayer = null;
    let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    // –°—Ç–∏–ª–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
    const markerStyles = {
      default: {
        radius: isMobile ? 8 : 6,
        fillColor: "#ff0000",
        color: "#fff",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      },
      small: {
        radius: isMobile ? 6 : 4,
        fillColor: "#ff0000",
        color: "#fff",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      },
      medium: {
        radius: isMobile ? 10 : 8,
        fillColor: "#ff0000",
        color: "#fff",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      },
      large: {
        radius: isMobile ? 14 : 12,
        fillColor: "#ff0000",
        color: "#fff",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      },
      notCleaned: {
        radius: isMobile ? 10 : 8,
        fillColor: "#ff0000",
        color: "#fff",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      },
      cleaned: {
        radius: isMobile ? 10 : 8,
        fillColor: "#4CAF50",
        color: "#fff",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    const map = L.map('map', {
      zoomControl: false,
      touchZoom: true,
      scrollWheelZoom: !isMobile,
      doubleClickZoom: true,
      boxZoom: false,
      keyboard: true,
      dragging: true,
      tap: !L.Browser.mobile,
      zoomSnap: 0.5
    }).setView([60.5, 72.2], 6);

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ —Å–ª–æ—è OSM
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // –°–ª–æ–∏ –∫–∞—Ä—Ç—ã Sentinel Hub
    const baseLayers = {
      "–°–ø—É—Ç–Ω–∏–∫": L.tileLayer(
        'https://services.sentinel-hub.com/ogc/wms/10084d2d-cc90-4fd3-8c37-8c6f72f892b9?' +
        'SERVICE=WMS&REQUEST=GetMap&LAYERS=TRUE-COLOR-S2-L1C&' +
        'BBOX=60,65,75,55&WIDTH=1200&HEIGHT=800&' +
        'TIME=2024-01-01/2024-05-31&FORMAT=image/jpeg&SHOWLOGO=false',
        {
          attribution: 'Sentinel-2 ¬© ESA/Sentinel Hub',
          maxZoom: 18,
          detectRetina: true
        }
      ),
      "–ì–æ—Ä–æ–¥": L.tileLayer(
        'https://services.sentinel-hub.com/ogc/wms/10084d2d-cc90-4fd3-8c37-8c6f72f892b9?' +
        'SERVICE=WMS&REQUEST=GetMap&LAYERS=URBAN&' +
        'BBOX=60,65,75,55&WIDTH=1200&HEIGHT=800&' +
        'TIME=2024-01-01/2024-05-31&FORMAT=image/jpeg&SHOWLOGO=false',
        {
          attribution: 'Sentinel-2 ¬© ESA/Sentinel Hub',
          maxZoom: 18,
          detectRetina: true
        }
      ),
      "–ú–µ—Å—Ç–Ω–æ—Å—Ç—å": L.tileLayer(
        'https://services.sentinel-hub.com/ogc/wms/10084d2d-cc90-4fd3-8c37-8c6f72f892b9?' +
        'SERVICE=WMS&REQUEST=GetMap&LAYERS=SWIR&' +
        'BBOX=60,65,75,55&WIDTH=1200&HEIGHT=800&' +
        'TIME=2024-01-01/2024-05-31&FORMAT=image/jpeg&SHOWLOGO=false',
        {
          attribution: 'Sentinel-2 ¬© ESA/Sentinel Hub',
          maxZoom: 18,
          detectRetina: true
        }
      )
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      
      try {
        loading.style.display = 'block';
        
        const response = await fetch('hm_test.json?_=' + Date.now());
        
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);
        
        const text = await response.text();
        const cleanedText = text
          .replace(/^\uFEFF/, '')
          .replace(/,\s*\]/g, ']')
          .replace(/,\s*}/g, '}');
        
        currentData = JSON.parse(cleanedText);
        if (!Array.isArray(currentData)) throw new Error("–û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤");
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–æ–π –º–∞—Ä–∫–µ—Ä–æ–≤
        if (markersLayer) {
          map.removeLayer(markersLayer);
        }
        
        // –°–æ–∑–¥–∞–µ–º GeoJSON —Å–ª–æ–π
        markersLayer = L.geoJSON({
          type: "FeatureCollection",
          features: currentData.map(item => ({
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [item.–î–æ–ª–≥–æ—Ç–∞, item.–®–∏—Ä–æ—Ç–∞]
            },
            properties: item
          }))
        }, {
          pointToLayer: (feature, latlng) => {
            const marker = L.circleMarker(latlng, markerStyle);
            marker.on('click', () => {
              selectedMarker = feature.properties['ID –∫–∞—Ä—Ç–æ—á–∫–∏'];
            });
            return marker;
          },
          onEachFeature: (feature, layer) => {
            const props = feature.properties;
            let popupContent = `<div style="max-width: 300px; font-size: ${isMobile ? '14px' : '12px'}">`;
            popupContent += `<b>${props.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ || '–û–±—ä–µ–∫—Ç'}</b><hr style="margin:5px 0">`;
            popupContent += `<small>`;
            popupContent += `<b>ID:</b> ${props['ID –∫–∞—Ä—Ç–æ—á–∫–∏'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</b> ${props.–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</b> ${props['–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤:</b> ${props['–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–û–±—ä–µ–º:</b> ${props['–û–±—ä–µ–º, –º3'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'} –º¬≥<br>`;
            
            if (props['–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã']) {
              const images = props['–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã'].split(';').filter(img => img.trim() !== '');
              if (images.length > 0) {
                popupContent += `<b>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:</b><br>`;
                images.forEach(img => {
                  popupContent += `<img src="/gisimage/${img}" style="max-width:100%; margin-top:5px;"><br>`;
                });
              }
            }
            
            popupContent += `<button onclick="showPhotoModal(${props['ID –∫–∞—Ä—Ç–æ—á–∫–∏']})" 
              style="margin-top:10px; padding: 8px; font-size: ${isMobile ? '14px' : '12px'}">
              <i class="fas fa-camera"></i> –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
            </button>`;
            
            popupContent += `</small></div>`;
            
            layer.bindPopup(popupContent, {
              maxWidth: 300,
              className: isMobile ? 'mobile-popup' : ''
            });
          }
        }).addTo(map);
        
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
        if (currentData.length > 0) {
          map.fitBounds(markersLayer.getBounds(), { 
            padding: [50, 50],
            maxZoom: isMobile ? 14 : 16
          });
        }
        
        // –í–∫–ª—é—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª–æ–π
        baseLayers["–°–ø—É—Ç–Ω–∏–∫"].addTo(map);
        loading.style.display = 'none';
        
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
        loading.style.display = 'none';
        error.innerHTML = `
          <strong>–û—à–∏–±–∫–∞:</strong> ${err.message}<br><br>
          <small>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏</small>
        `;
        error.style.display = 'block';
        setTimeout(() => error.style.display = 'none', 5000);
      }
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è–º–∏
    function setupLayerControls() {
      const satelliteBtn = document.getElementById('satelliteBtn');
      const urbanBtn = document.getElementById('urbanBtn');
      const terrainBtn = document.getElementById('terrainBtn');
      
      function setActiveLayer(layerName) {
        Object.values(baseLayers).forEach(layer => {
          if (map.hasLayer(layer)) map.removeLayer(layer);
        });
        baseLayers[layerName].addTo(map);
        [satelliteBtn, urbanBtn, terrainBtn].forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${layerName.toLowerCase()}Btn`).classList.add('active');
      }
      
      satelliteBtn.addEventListener('click', () => setActiveLayer("–°–ø—É—Ç–Ω–∏–∫"));
      urbanBtn.addEventListener('click', () => setActiveLayer("–ì–æ—Ä–æ–¥"));
      terrainBtn.addEventListener('click', () => setActiveLayer("–ú–µ—Å—Ç–Ω–æ—Å—Ç—å"));
    }

    // –ú–æ–±–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function setupMobileControls() {
      document.getElementById('zoomIn').addEventListener('click', () => map.zoomIn());
      document.getElementById('zoomOut').addEventListener('click', () => map.zoomOut());
      
      document.getElementById('locate').addEventListener('click', () => {
        if (navigator.geolocation) {
          const loading = document.getElementById('loading');
          loading.style.display = 'block';
          loading.textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...';
          
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              map.flyTo([pos.coords.latitude, pos.coords.longitude], 14);
              loading.style.display = 'none';
            },
            (err) => {
              loading.style.display = 'none';
              alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ' + err.message);
            },
            { 
              enableHighAccuracy: true, 
              timeout: 10000,
              maximumAge: 0
            }
          );
        } else {
          alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é');
        }
      });
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    function setupAddObject() {
      const addModal = document.getElementById('addModal');
      const addForm = document.getElementById('addForm');
      const cancelAdd = document.getElementById('cancelAdd');
      const photoUpload = document.getElementById('photoUpload');
      const photoPreview = document.getElementById('photoPreview');
      
      document.getElementById('addBtn').addEventListener('click', () => {
        addModal.style.display = 'flex';
      });
      
      cancelAdd.addEventListener('click', () => {
        addModal.style.display = 'none';
        addForm.reset();
        photoPreview.style.display = 'none';
      });
      
      photoUpload.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = (event) => {
            photoPreview.src = event.target.result;
            photoPreview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
      
      addForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const loading = document.getElementById('loading');
        loading.style.display = 'block';
        loading.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞...';
        
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 0
            });
          });
          
          const formData = new FormData(addForm);
          const newObj = {
            "ID –∫–∞—Ä—Ç–æ—á–∫–∏": Math.max(...currentData.map(item => item['ID –∫–∞—Ä—Ç–æ—á–∫–∏']), 0) + 1,
            "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ": formData.get('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'),
            "‚Ññ –≤ —Ä–µ–µ—Å—Ç—Ä–µ": "",
            "–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è": new Date().toLocaleDateString('ru-RU'),
            "–í–∏–¥ –æ–±—ä–µ–∫—Ç–∞": "–ó–∞—Ö–ª–∞–º–ª–µ–Ω–∏–µ",
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–µ–º–µ–ª—å": "",
            "–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": "",
            "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ": "",
            "–î–æ–ª–≥–æ—Ç–∞": position.coords.longitude,
            "–®–∏—Ä–æ—Ç–∞": position.coords.latitude,
            "–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤": formData.get('–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤'),
            "–ü–ª–æ—â–∞–¥—å, –≥–∞": "",
            "–û–±—ä–µ–º, –º3": formData.get('–û–±—ä–µ–º, –º3'),
            "–û—Ç–º–µ—Ç–∫–∞ –æ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏": "–Ω–µ—Ç",
            "–î–∞—Ç–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏": "",
            "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ": "",
            "–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã": ""
          };
          
          if (photoUpload.files.length > 0) {
            loading.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏...';
            const photoForm = new FormData();
            photoForm.append('photo', photoUpload.files[0]);
            photoForm.append('id', newObj['ID –∫–∞—Ä—Ç–æ—á–∫–∏']);
            
            const uploadResponse = await fetch(API_ENDPOINT, {
              method: 'POST',
              body: photoForm
            });
            
            if (!uploadResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ');
            
            const result = await uploadResponse.json();
            newObj['–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã'] = result.filename;
          }
          
          currentData.push(newObj);
          await saveData();
          
          addModal.style.display = 'none';
          addForm.reset();
          photoPreview.style.display = 'none';
          loadData();
          
        } catch (err) {
          loading.style.display = 'none';
          alert('–û—à–∏–±–∫–∞: ' + err.message);
          console.error(err);
        }
      });
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
    function setupPhotoUpload() {
      const photoModal = document.getElementById('photoModal');
      const photoForm = document.getElementById('photoForm');
      const cancelPhoto = document.getElementById('cancelPhoto');
      const objectPhoto = document.getElementById('objectPhoto');
      const objectPhotoPreview = document.getElementById('objectPhotoPreview');
      
      window.showPhotoModal = (id) => {
        selectedMarker = id;
        photoModal.style.display = 'flex';
      };
      
      cancelPhoto.addEventListener('click', () => {
        photoModal.style.display = 'none';
        photoForm.reset();
        objectPhotoPreview.style.display = 'none';
      });
      
      objectPhoto.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = (event) => {
            objectPhotoPreview.src = event.target.result;
            objectPhotoPreview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
      
      photoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const loading = document.getElementById('loading');
        loading.style.display = 'block';
        loading.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏...';
        
        try {
          if (!selectedMarker) throw new Error('–ù–µ –≤—ã–±—Ä–∞–Ω –æ–±—ä–µ–∫—Ç');
          if (objectPhoto.files.length === 0) throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ');
          
          const photoFormData = new FormData();
          photoFormData.append('photo', objectPhoto.files[0]);
          photoFormData.append('id', selectedMarker);
          
          const uploadResponse = await fetch(API_ENDPOINT, {
            method: 'POST',
            body: photoFormData
          });
          
          if (!uploadResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ');
          
          const result = await uploadResponse.json();
          
          const objIndex = currentData.findIndex(item => item['ID –∫–∞—Ä—Ç–æ—á–∫–∏'] === selectedMarker);
          if (objIndex !== -1) {
            const currentFiles = currentData[objIndex]['–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã'] || '';
            currentData[objIndex]['–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã'] = 
              currentFiles ? `${currentFiles};${result.filename}` : result.filename;
            
            await saveData();
            loadData();
          }
          
          photoModal.style.display = 'none';
          photoForm.reset();
          objectPhotoPreview.style.display = 'none';
          
        } catch (err) {
          loading.style.display = 'none';
          alert('–û—à–∏–±–∫–∞: ' + err.message);
          console.error(err);
        }
      });
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    async function saveData() {
      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'save',
            data: currentData
          })
        });
        
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
        throw err;
      }
    }

    // –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤
    function setupSearch() {
      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');
      
      searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        searchResults.innerHTML = '';
        
        if (query.length < 2) {
          searchResults.style.display = 'none';
          return;
        }
        
        const results = currentData.filter(item => {
          return (
            (item['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'] && item['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'].toLowerCase().includes(query)) ||
            (item['–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤'] && item['–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤'].toLowerCase().includes(query)) ||
            (item['–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'] && item['–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'].toLowerCase().includes(query))
          );
        });
        
        if (results.length > 0) {
          results.forEach(item => {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.textContent = item['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'] || '–û–±—ä–µ–∫—Ç –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            resultItem.addEventListener('click', () => {
              map.flyTo([item.–®–∏—Ä–æ—Ç–∞, item.–î–æ–ª–≥–æ—Ç–∞], 16);
              searchResults.style.display = 'none';
              searchInput.value = '';
              
              markersLayer.eachLayer(layer => {
                if (layer.feature && layer.feature.properties['ID –∫–∞—Ä—Ç–æ—á–∫–∏'] === item['ID –∫–∞—Ä—Ç–æ—á–∫–∏']) {
                  layer.openPopup();
                }
              });
            });
            searchResults.appendChild(resultItem);
          });
          searchResults.style.display = 'block';
        } else {
          const noResults = document.createElement('div');
          noResults.className = 'search-result-item';
          noResults.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
          searchResults.appendChild(noResults);
          searchResults.style.display = 'block';
        }
      });
      
      document.addEventListener('click', function(e) {
        if (e.target !== searchInput && e.target !== searchResults) {
          searchResults.style.display = 'none';
        }
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      if (isMobile) {
        // –£–º–µ–Ω—å—à–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Ç–∞–ø–æ–≤
        L.DomEvent.on(document, 'touchstart', L.DomEvent.stopPropagation);
        
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–æ–Ω—É –∫–ª–∏–∫–∞ –¥–ª—è –ø–æ–ø–∞–ø–æ–≤
        L.Popup.prototype.options.autoPanPaddingTopLeft = L.point(20, 20);
        L.Popup.prototype.options.autoPanPaddingBottomRight = L.point(20, 20);
        
        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        L.DomUtil.setOptions(map, {
          preferCanvas: true
        });
      }
      
      setupLayerControls();
      setupMobileControls();
      setupAddObject();
      setupPhotoUpload();
      setupSearch();
      loadData();
    });
  </script>
</body>
</html>
