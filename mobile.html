<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ö–∞—Ä—Ç–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –º—É—Å–æ—Ä–∞</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      touch-action: manipulation;
    }
    #map-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    h2 {
      text-align: center;
      padding: 10px;
      margin: 0;
      background-color: #f8f9fa;
      font-size: 1.2rem;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 5px;
      z-index: 1000;
      text-align: center;
    }
    .error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,0,0,0.8);
      color: white;
      padding: 20px;
      border-radius: 5px;
      z-index: 1000;
      text-align: center;
      max-width: 80%;
      display: none;
    }
    .map-controls {
      position: absolute;
      top: 70px;
      right: 10px;
      z-index: 500;
      display: flex;
      flex-direction: column;
    }
    .control-btn {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      user-select: none;
    }
    .control-btn.active {
      background: #4CAF50;
      color: white;
      border-color: #388E3C;
    }
    .mobile-controls {
      position: absolute;
      bottom: 20px;
      right: 10px;
      z-index: 500;
    }
    @media (min-width: 768px) {
      h2 {
        font-size: 1.5rem;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div id="map-container">
    <h2>–û–±—ä–µ–∫—Ç—ã –∑–∞—Ö–ª–∞–º–ª–µ–Ω–∏—è</h2>
    <div id="map"></div>
    <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    <div class="error" id="error"></div>
    
    <div class="map-controls" id="mapControls">
      <div class="control-btn active" id="satelliteBtn" title="–°–ø—É—Ç–Ω–∏–∫">üõ∞</div>
      <div class="control-btn" id="urbanBtn" title="–ì–æ—Ä–æ–¥">üèô</div>
      <div class="control-btn" id="terrainBtn" title="–ú–µ—Å—Ç–Ω–æ—Å—Ç—å">‚õ∞</div>
    </div>
    
    <div class="mobile-controls" id="mobileControls">
      <div class="control-btn" id="zoomIn">+</div>
      <div class="control-btn" id="zoomOut">-</div>
      <div class="control-btn" id="locate">‚åñ</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Å fallback-—Ü–µ–Ω—Ç—Ä–æ–º
    const map = L.map('map', {
      zoomControl: false,
      touchZoom: true,
      scrollWheelZoom: true,
      doubleClickZoom: true,
      boxZoom: false,
      keyboard: true,
      dragging: true
    }).setView([60.5, 72.2], 6);
    
    console.log("–ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞");

    // 2. –î–æ–±–∞–≤–∏–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ª–æ–π OSM –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);
    console.log("–î–æ–±–∞–≤–ª–µ–Ω —Å–ª–æ–π OSM");

    // 3. –°–ª–æ–∏ –∫–∞—Ä—Ç—ã Sentinel Hub
    const baseLayers = {
      "–°–ø—É—Ç–Ω–∏–∫": L.tileLayer(
        'https://services.sentinel-hub.com/ogc/wms/10084d2d-cc90-4fd3-8c37-8c6f72f892b9?' +
        'SERVICE=WMS&REQUEST=GetMap&LAYERS=TRUE-COLOR-S2-L1C&' +
        'BBOX=60,65,75,55&WIDTH=1200&HEIGHT=800&' +
        'TIME=2024-01-01/2024-05-31&FORMAT=image/jpeg&SHOWLOGO=false',
        {
          attribution: 'Sentinel-2 ¬© ESA/Sentinel Hub',
          maxZoom: 18,
          detectRetina: true
        }
      ),
      "–ì–æ—Ä–æ–¥": L.tileLayer(
        'https://services.sentinel-hub.com/ogc/wms/10084d2d-cc90-4fd3-8c37-8c6f72f892b9?' +
        'SERVICE=WMS&REQUEST=GetMap&LAYERS=URBAN&' +
        'BBOX=60,65,75,55&WIDTH=1200&HEIGHT=800&' +
        'TIME=2024-01-01/2024-05-31&FORMAT=image/jpeg&SHOWLOGO=false',
        {
          attribution: 'Sentinel-2 ¬© ESA/Sentinel Hub',
          maxZoom: 18,
          detectRetina: true
        }
      ),
      "–ú–µ—Å—Ç–Ω–æ—Å—Ç—å": L.tileLayer(
        'https://services.sentinel-hub.com/ogc/wms/10084d2d-cc90-4fd3-8c37-8c6f72f892b9?' +
        'SERVICE=WMS&REQUEST=GetMap&LAYERS=SWIR&' +
        'BBOX=60,65,75,55&WIDTH=1200&HEIGHT=800&' +
        'TIME=2024-01-01/2024-05-31&FORMAT=image/jpeg&SHOWLOGO=false',
        {
          attribution: 'Sentinel-2 ¬© ESA/Sentinel Hub',
          maxZoom: 18,
          detectRetina: true
        }
      )
    };

    // 4. –°—Ç–∏–ª—å –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
    const markerStyle = {
      radius: 8,
      fillColor: "#ff0000",
      color: "#fff",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    };

    // 5. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      
      try {
        console.log("–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ hm.json");
        const response = await fetch('hm_test.json?_=' + Date.now()); // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        console.log("–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
        
        // –ß–∏—Å—Ç–∏–º JSON –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
        const cleanedText = text
          .replace(/^\uFEFF/, '') // –£–¥–∞–ª—è–µ–º BOM
          .replace(/,\s*\]/g, ']') // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–ø—è—Ç—ã–µ
          .replace(/,\s*}/g, '}'); // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–ø—è—Ç—ã–µ –≤ –æ–±—ä–µ–∫—Ç–∞—Ö
        
        const data = JSON.parse(cleanedText);
        console.log("JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω");
        
        if (!Array.isArray(data)) {
          throw new Error("–û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤");
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
        if (data.length === 0) {
          throw new Error("–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö");
        }
        
        const firstItem = data[0];
        if (typeof firstItem.–î–æ–ª–≥–æ—Ç–∞ === 'undefined' || typeof firstItem.–®–∏—Ä–æ—Ç–∞ === 'undefined') {
          throw new Error("–û–±—ä–µ–∫—Ç—ã –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–ª—è '–î–æ–ª–≥–æ—Ç–∞' –∏ '–®–∏—Ä–æ—Ç–∞'");
        }
        
        // –°–æ–∑–¥–∞–µ–º GeoJSON —Å–ª–æ–π
        const geoJsonLayer = L.geoJSON({
          type: "FeatureCollection",
          features: data.map(item => ({
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [item.–î–æ–ª–≥–æ—Ç–∞, item.–®–∏—Ä–æ—Ç–∞]
            },
            properties: item
          }))
        }, {
          pointToLayer: (feature, latlng) => L.circleMarker(latlng, markerStyle),
          onEachFeature: (feature, layer) => {
            const props = feature.properties;
            let popupContent = `<div style="max-width: 300px">`;
            popupContent += `<b>${props.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ || '–û–±—ä–µ–∫—Ç'}</b><hr style="margin:5px 0">`;
            popupContent += `<small>`;
            popupContent += `<b>ID:</b> ${props['ID –∫–∞—Ä—Ç–æ—á–∫–∏'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</b> ${props.–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</b> ${props['–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤:</b> ${props['–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–û–±—ä–µ–º:</b> ${props['–û–±—ä–µ–º, –º3'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'} –º¬≥<br>`;
            if (props['–û—Ç–º–µ—Ç–∫–∞ –æ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏'] === '–¥–∞') {
              popupContent += `<b style="color:green">–õ–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω:</b> ${props['–î–∞—Ç–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            }
            popupContent += `</small></div>`;
            
            layer.bindPopup(popupContent);
          }
        }).addTo(map);
        
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
        map.fitBounds(geoJsonLayer.getBounds(), { padding: [50, 50] });
        
        // –í–∫–ª—é—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª–æ–π
        baseLayers["–°–ø—É—Ç–Ω–∏–∫"].addTo(map);
        map.removeLayer(document.querySelector('.leaflet-tile-container img').parentElement); // –£–¥–∞–ª—è–µ–º OSM
        
        loading.style.display = 'none';
        console.log("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã");
        
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
        loading.style.display = 'none';
        error.innerHTML = `
          <strong>–û—à–∏–±–∫–∞:</strong> ${err.message}<br><br>
          –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:<br>
          1. –§–∞–π–ª hm.json –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ<br>
          2. –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤)<br>
          3. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏<br>
          <small>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ (F12 ‚Üí Console)</small>
        `;
        error.style.display = 'block';
      }
    }

    // 6. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è–º–∏
    function setupLayerControls() {
      const satelliteBtn = document.getElementById('satelliteBtn');
      const urbanBtn = document.getElementById('urbanBtn');
      const terrainBtn = document.getElementById('terrainBtn');
      
      function setActiveLayer(layerName) {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –±–∞–∑–æ–≤—ã–µ —Å–ª–æ–∏
        Object.values(baseLayers).forEach(layer => {
          if (map.hasLayer(layer)) map.removeLayer(layer);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ª–æ–π
        baseLayers[layerName].addTo(map);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        [satelliteBtn, urbanBtn, terrainBtn].forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${layerName.toLowerCase()}Btn`).classList.add('active');
      }
      
      satelliteBtn.addEventListener('click', () => setActiveLayer("–°–ø—É—Ç–Ω–∏–∫"));
      urbanBtn.addEventListener('click', () => setActiveLayer("–ì–æ—Ä–æ–¥"));
      terrainBtn.addEventListener('click', () => setActiveLayer("–ú–µ—Å—Ç–Ω–æ—Å—Ç—å"));
    }

    // 7. –ú–æ–±–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function setupMobileControls() {
      document.getElementById('zoomIn').addEventListener('click', () => map.zoomIn());
      document.getElementById('zoomOut').addEventListener('click', () => map.zoomOut());
      
      document.getElementById('locate').addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => map.flyTo([pos.coords.latitude, pos.coords.longitude], 14),
            (err) => alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ' + err.message),
            { enableHighAccuracy: true, timeout: 10000 }
          );
        } else {
          alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é');
        }
      });
    }

    // 8. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      setupLayerControls();
      setupMobileControls();
      loadData();
    });
  </script>
</body>
</html>
