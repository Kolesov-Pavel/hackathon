<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ö–∞—Ä—Ç–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –º—É—Å–æ—Ä–∞</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      touch-action: manipulation;
    }
    #map-container {
      position: relative;
      width: 100%;
      height: 100vh;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    h2 {
      text-align: center;
      padding: 10px;
      margin: 0;
      background-color: #f8f9fa;
      font-size: 1.2rem;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 5px;
      z-index: 1000;
      text-align: center;
    }
    .error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,0,0,0.8);
      color: white;
      padding: 20px;
      border-radius: 5px;
      z-index: 1000;
      text-align: center;
      max-width: 80%;
      display: none;
    }
    .map-controls {
      position: absolute;
      top: 70px;
      right: 10px;
      z-index: 500;
      display: flex;
      flex-direction: column;
    }
    .control-btn {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      user-select: none;
    }
    .control-btn.active {
      background: #4CAF50;
      color: white;
      border-color: #388E3C;
    }
    .mobile-controls {
      position: absolute;
      bottom: 20px;
      right: 10px;
      z-index: 500;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 5px;
      width: 90%;
      max-width: 400px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
    .preview-image {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
    }
    @media (min-width: 768px) {
      h2 {
        font-size: 1.5rem;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div id="map-container">
    <h2>–û–±—ä–µ–∫—Ç—ã –∑–∞—Ö–ª–∞–º–ª–µ–Ω–∏—è</h2>
    <div id="map"></div>
    <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    <div class="error" id="error"></div>
    
    <div class="map-controls" id="mapControls">
      <div class="control-btn active" id="satelliteBtn" title="–°–ø—É—Ç–Ω–∏–∫">üõ∞</div>
      <div class="control-btn" id="urbanBtn" title="–ì–æ—Ä–æ–¥">üèô</div>
      <div class="control-btn" id="terrainBtn" title="–ú–µ—Å—Ç–Ω–æ—Å—Ç—å">‚õ∞</div>
      <div class="control-btn" id="addBtn" title="–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç"><i class="fas fa-plus"></i></div>
    </div>
    
    <div class="mobile-controls" id="mobileControls">
      <div class="control-btn" id="zoomIn">+</div>
      <div class="control-btn" id="zoomOut">-</div>
      <div class="control-btn" id="locate">‚åñ</div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ -->
  <div class="modal" id="addModal">
    <div class="modal-content">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç</h3>
      <form id="addForm">
        <div class="form-group">
          <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</label>
          <input type="text" name="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" required>
        </div>
        <div class="form-group">
          <label>–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤:</label>
          <input type="text" name="–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤" required>
        </div>
        <div class="form-group">
          <label>–û–±—ä–µ–º (–º¬≥):</label>
          <input type="number" name="–û–±—ä–µ–º, –º3" step="0.1" required>
        </div>
        <div class="form-group">
          <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è:</label>
          <input type="file" id="photoUpload" accept="image/*">
          <img id="photoPreview" class="preview-image" style="display: none;">
        </div>
        <div class="form-group">
          <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button type="button" id="cancelAdd">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ -->
  <div class="modal" id="photoModal">
    <div class="modal-content">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</h3>
      <form id="photoForm">
        <div class="form-group">
          <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ:</label>
          <input type="file" id="objectPhoto" accept="image/*" required>
          <img id="objectPhotoPreview" class="preview-image" style="display: none;">
        </div>
        <div class="form-group">
          <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <button type="button" id="cancelPhoto">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentData = [];
    let selectedMarker = null;
    const API_ENDPOINT = 'api.php'; // –§–∞–π–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    const map = L.map('map', {
      zoomControl: false,
      touchZoom: true,
      scrollWheelZoom: true,
      doubleClickZoom: true,
      boxZoom: false,
      keyboard: true,
      dragging: true
    }).setView([60.5, 72.2], 6);

    // 2. –°–ª–æ–∏ –∫–∞—Ä—Ç—ã Sentinel Hub
    const baseLayers = {
      "–°–ø—É—Ç–Ω–∏–∫": L.tileLayer(
        'https://services.sentinel-hub.com/ogc/wms/10084d2d-cc90-4fd3-8c37-8c6f72f892b9?' +
        'SERVICE=WMS&REQUEST=GetMap&LAYERS=TRUE-COLOR-S2-L1C&' +
        'BBOX=60,65,75,55&WIDTH=1200&HEIGHT=800&' +
        'TIME=2024-01-01/2024-05-31&FORMAT=image/jpeg&SHOWLOGO=false',
        {
          attribution: 'Sentinel-2 ¬© ESA/Sentinel Hub',
          maxZoom: 18,
          detectRetina: true
        }
      ),
      "–ì–æ—Ä–æ–¥": L.tileLayer(
        'https://services.sentinel-hub.com/ogc/wms/10084d2d-cc90-4fd3-8c37-8c6f72f892b9?' +
        'SERVICE=WMS&REQUEST=GetMap&LAYERS=URBAN&' +
        'BBOX=60,65,75,55&WIDTH=1200&HEIGHT=800&' +
        'TIME=2024-01-01/2024-05-31&FORMAT=image/jpeg&SHOWLOGO=false',
        {
          attribution: 'Sentinel-2 ¬© ESA/Sentinel Hub',
          maxZoom: 18,
          detectRetina: true
        }
      ),
      "–ú–µ—Å—Ç–Ω–æ—Å—Ç—å": L.tileLayer(
        'https://services.sentinel-hub.com/ogc/wms/10084d2d-cc90-4fd3-8c37-8c6f72f892b9?' +
        'SERVICE=WMS&REQUEST=GetMap&LAYERS=SWIR&' +
        'BBOX=60,65,75,55&WIDTH=1200&HEIGHT=800&' +
        'TIME=2024-01-01/2024-05-31&FORMAT=image/jpeg&SHOWLOGO=false',
        {
          attribution: 'Sentinel-2 ¬© ESA/Sentinel Hub',
          maxZoom: 18,
          detectRetina: true
        }
      )
    };

    // 3. –°—Ç–∏–ª—å –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
    const markerStyle = {
      radius: 8,
      fillColor: "#ff0000",
      color: "#fff",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    };

    // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      
      try {
        const response = await fetch('hm_test.json?_=' + Date.now());
        
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const text = await response.text();
        const cleanedText = text
          .replace(/^\uFEFF/, '')
          .replace(/,\s*\]/g, ']')
          .replace(/,\s*}/g, '}');
        
        currentData = JSON.parse(cleanedText);
        if (!Array.isArray(currentData)) throw new Error("–û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤");
        
        // –°–æ–∑–¥–∞–µ–º GeoJSON —Å–ª–æ–π
        const geoJsonLayer = L.geoJSON({
          type: "FeatureCollection",
          features: currentData.map(item => ({
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [item.–î–æ–ª–≥–æ—Ç–∞, item.–®–∏—Ä–æ—Ç–∞]
            },
            properties: item
          }))
        }, {
          pointToLayer: (feature, latlng) => {
            const marker = L.circleMarker(latlng, markerStyle);
            marker.on('click', () => {
              selectedMarker = feature.properties['ID –∫–∞—Ä—Ç–æ—á–∫–∏'];
            });
            return marker;
          },
          onEachFeature: (feature, layer) => {
            const props = feature.properties;
            let popupContent = `<div style="max-width: 300px">`;
            popupContent += `<b>${props.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ || '–û–±—ä–µ–∫—Ç'}</b><hr style="margin:5px 0">`;
            popupContent += `<small>`;
            popupContent += `<b>ID:</b> ${props['ID –∫–∞—Ä—Ç–æ—á–∫–∏'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</b> ${props.–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:</b> ${props['–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤:</b> ${props['–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}<br>`;
            popupContent += `<b>–û–±—ä–µ–º:</b> ${props['–û–±—ä–µ–º, –º3'] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'} –º¬≥<br>`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if (props['–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã']) {
              const images = props['–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã'].split(';').filter(img => img.trim() !== '');
              if (images.length > 0) {
                popupContent += `<b>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:</b><br>`;
                images.forEach(img => {
                  popupContent += `<img src="/gisimage/${img}" style="max-width:100%; margin-top:5px;"><br>`;
                });
              }
            }
            
            // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
            popupContent += `<button onclick="showPhotoModal(${props['ID –∫–∞—Ä—Ç–æ—á–∫–∏']})" style="margin-top:10px;">
              <i class="fas fa-camera"></i> –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
            </button>`;
            
            popupContent += `</small></div>`;
            
            layer.bindPopup(popupContent);
          }
        }).addTo(map);
        
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
        if (currentData.length > 0) {
          map.fitBounds(geoJsonLayer.getBounds(), { padding: [50, 50] });
        }
        
        // –í–∫–ª—é—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª–æ–π
        baseLayers["–°–ø—É—Ç–Ω–∏–∫"].addTo(map);
        loading.style.display = 'none';
        
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
        loading.style.display = 'none';
        error.innerHTML = `
          <strong>–û—à–∏–±–∫–∞:</strong> ${err.message}<br><br>
          <small>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ (F12 ‚Üí Console)</small>
        `;
        error.style.display = 'block';
      }
    }

    // 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è–º–∏
    function setupLayerControls() {
      const satelliteBtn = document.getElementById('satelliteBtn');
      const urbanBtn = document.getElementById('urbanBtn');
      const terrainBtn = document.getElementById('terrainBtn');
      
      function setActiveLayer(layerName) {
        Object.values(baseLayers).forEach(layer => {
          if (map.hasLayer(layer)) map.removeLayer(layer);
        });
        baseLayers[layerName].addTo(map);
        [satelliteBtn, urbanBtn, terrainBtn].forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${layerName.toLowerCase()}Btn`).classList.add('active');
      }
      
      satelliteBtn.addEventListener('click', () => setActiveLayer("–°–ø—É—Ç–Ω–∏–∫"));
      urbanBtn.addEventListener('click', () => setActiveLayer("–ì–æ—Ä–æ–¥"));
      terrainBtn.addEventListener('click', () => setActiveLayer("–ú–µ—Å—Ç–Ω–æ—Å—Ç—å"));
    }

    // 6. –ú–æ–±–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function setupMobileControls() {
      document.getElementById('zoomIn').addEventListener('click', () => map.zoomIn());
      document.getElementById('zoomOut').addEventListener('click', () => map.zoomOut());
      
      document.getElementById('locate').addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => map.flyTo([pos.coords.latitude, pos.coords.longitude], 14),
            (err) => alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ' + err.message),
            { enableHighAccuracy: true, timeout: 10000 }
          );
        } else {
          alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é');
        }
      });
    }

    // 7. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    function setupAddObject() {
      const addModal = document.getElementById('addModal');
      const addForm = document.getElementById('addForm');
      const cancelAdd = document.getElementById('cancelAdd');
      const photoUpload = document.getElementById('photoUpload');
      const photoPreview = document.getElementById('photoPreview');
      
      // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      document.getElementById('addBtn').addEventListener('click', () => {
        addModal.style.display = 'flex';
      });
      
      // –°–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      cancelAdd.addEventListener('click', () => {
        addModal.style.display = 'none';
        addForm.reset();
        photoPreview.style.display = 'none';
      });
      
      // –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
      photoUpload.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = (event) => {
            photoPreview.src = event.target.result;
            photoPreview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
      
      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
      addForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              enableHighAccuracy: true,
              timeout: 10000
            });
          });
          
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç
          const formData = new FormData(addForm);
          const newObj = {
            "ID –∫–∞—Ä—Ç–æ—á–∫–∏": Math.max(...currentData.map(item => item['ID –∫–∞—Ä—Ç–æ—á–∫–∏']), 0) + 1,
            "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ": formData.get('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'),
            "‚Ññ –≤ —Ä–µ–µ—Å—Ç—Ä–µ": "",
            "–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è": new Date().toLocaleDateString('ru-RU'),
            "–í–∏–¥ –æ–±—ä–µ–∫—Ç–∞": "–ó–∞—Ö–ª–∞–º–ª–µ–Ω–∏–µ",
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–µ–º–µ–ª—å": "",
            "–ú—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": "",
            "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ": "",
            "–î–æ–ª–≥–æ—Ç–∞": position.coords.longitude,
            "–®–∏—Ä–æ—Ç–∞": position.coords.latitude,
            "–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤": formData.get('–¢–∏–ø –æ—Ç—Ö–æ–¥–æ–≤'),
            "–ü–ª–æ—â–∞–¥—å, –≥–∞": "",
            "–û–±—ä–µ–º, –º3": formData.get('–û–±—ä–µ–º, –º3'),
            "–û—Ç–º–µ—Ç–∫–∞ –æ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏": "–Ω–µ—Ç",
            "–î–∞—Ç–∞ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏": "",
            "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ": "",
            "–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã": ""
          };
          
          // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ - –∑–∞–≥—Ä—É–∂–∞–µ–º
          if (photoUpload.files.length > 0) {
            const photoForm = new FormData();
            photoForm.append('photo', photoUpload.files[0]);
            photoForm.append('id', newObj['ID –∫–∞—Ä—Ç–æ—á–∫–∏']);
            
            const uploadResponse = await fetch(API_ENDPOINT, {
              method: 'POST',
              body: photoForm
            });
            
            if (!uploadResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ');
            
            const result = await uploadResponse.json();
            newObj['–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã'] = result.filename;
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
          currentData.push(newObj);
          await saveData();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
          addModal.style.display = 'none';
          addForm.reset();
          photoPreview.style.display = 'none';
          loadData();
          
        } catch (err) {
          alert('–û—à–∏–±–∫–∞: ' + err.message);
          console.error(err);
        }
      });
    }

    // 8. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –æ–±—ä–µ–∫—Ç–∞–º
    function setupPhotoUpload() {
      const photoModal = document.getElementById('photoModal');
      const photoForm = document.getElementById('photoForm');
      const cancelPhoto = document.getElementById('cancelPhoto');
      const objectPhoto = document.getElementById('objectPhoto');
      const objectPhotoPreview = document.getElementById('objectPhotoPreview');
      
      // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      window.showPhotoModal = (id) => {
        selectedMarker = id;
        photoModal.style.display = 'flex';
      };
      
      // –°–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      cancelPhoto.addEventListener('click', () => {
        photoModal.style.display = 'none';
        photoForm.reset();
        objectPhotoPreview.style.display = 'none';
      });
      
      // –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
      objectPhoto.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = (event) => {
            objectPhotoPreview.src = event.target.result;
            objectPhotoPreview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });
      
      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
      photoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          if (!selectedMarker) throw new Error('–ù–µ –≤—ã–±—Ä–∞–Ω –æ–±—ä–µ–∫—Ç');
          if (objectPhoto.files.length === 0) throw new Error('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ');
          
          const photoFormData = new FormData();
          photoFormData.append('photo', objectPhoto.files[0]);
          photoFormData.append('id', selectedMarker);
          
          const uploadResponse = await fetch(API_ENDPOINT, {
            method: 'POST',
            body: photoFormData
          });
          
          if (!uploadResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ');
          
          const result = await uploadResponse.json();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç
          const objIndex = currentData.findIndex(item => item['ID –∫–∞—Ä—Ç–æ—á–∫–∏'] === selectedMarker);
          if (objIndex !== -1) {
            const currentFiles = currentData[objIndex]['–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã'] || '';
            currentData[objIndex]['–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã'] = 
              currentFiles ? `${currentFiles};${result.filename}` : result.filename;
            
            await saveData();
            loadData();
          }
          
          photoModal.style.display = 'none';
          photoForm.reset();
          objectPhotoPreview.style.display = 'none';
          
        } catch (err) {
          alert('–û—à–∏–±–∫–∞: ' + err.message);
          console.error(err);
        }
      });
    }

    // 9. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    async function saveData() {
      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'save',
            data: currentData
          })
        });
        
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
        
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
        throw err;
      }
    }

    // 10. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      setupLayerControls();
      setupMobileControls();
      setupAddObject();
      setupPhotoUpload();
      loadData();
    });
  </script>
</body>
</html>
